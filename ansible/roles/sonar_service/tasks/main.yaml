---
- name: Deploy SonarQube
  community.docker.docker_swarm_service:
    name: sonarqube
    image: "sonarqube:latest"
    mode: global
    mounts:
      - source: sonarqube_data
        target:
    networks:
      - traefik
    env:
      SONARQUBE_JDBC_URL: "jdbc:postgresql://db:5432/sonarqube"
      SONARQUBE_JDBC_USERNAME: "sonar"
      SONARQUBE_JDBC_PASSWORD: "sonar"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.sonarqube.rule=Host(`sonar.deed1t.master-sdl.ovh`)"
      - "traefik.http.routers.sonarqube.entrypoints=websecure"
      - "traefik.http.routers.sonarqube.tls.certresolver=letsencryptresolver"
      - "traefik.http.services.sonarqube.loadbalancer.server.port=9000"

- name: Ensure PostgreSQL is running
  community.docker.docker_swarm_service:
    name: db
    image: "postgres:latest"
    env:
      POSTGRES_DB: "sonarqube"
      POSTGRES_USER: "sonar"
      POSTGRES_PASSWORD: "sonar"
    deploy:
      replicas: 1
    networks:
      - traefik